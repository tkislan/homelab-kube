---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubewatch
  namespace: kubewatch
spec:
  interval: 10m
  timeout: 5m
  chart:
    spec:
      chart: kubewatch
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: robusta
        namespace: kube-system
      interval: 5m
  releaseName: kubewatch
  values:
    rbac:
      create: true
      customRoles:
        # Standard K8s resources not covered by default RBAC
        - apiGroups: [""]
          resources: ["serviceaccounts"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["rbac.authorization.k8s.io"]
          resources: ["clusterroles", "clusterrolebindings"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["events.k8s.io"]
          resources: ["events"]
          verbs: ["get", "list", "watch"]
        # Flux custom resources
        - apiGroups: ["kustomize.toolkit.fluxcd.io"]
          resources: ["kustomizations"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["helm.toolkit.fluxcd.io"]
          resources: ["helmreleases"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["source.toolkit.fluxcd.io"]
          resources: ["gitrepositories", "helmrepositories", "helmcharts"]
          verbs: ["get", "list", "watch"]
    resourcesToWatch:
      deployment: false
      replicationcontroller: false
      replicaset: false
      daemonset: false
      services: true
      pod: true
      job: false
      node: false
      clusterrole: true
      clusterrolebinding: true
      serviceaccount: true
      persistentvolume: false
      namespace: false
      secret: false
      configmap: false
      ingress: false
      coreevent: false
      event: true
    customresources:
      - group: kustomize.toolkit.fluxcd.io
        version: v1
        resource: kustomizations
      - group: helm.toolkit.fluxcd.io
        version: v2
        resource: helmreleases
      - group: source.toolkit.fluxcd.io
        version: v1
        resource: gitrepositories
      - group: source.toolkit.fluxcd.io
        version: v1
        resource: helmrepositories
      - group: source.toolkit.fluxcd.io
        version: v1
        resource: helmcharts
    slack:
      enabled: false
    slackwebhook:
      enabled: true
      channel: "#kubewatch-homelab"
      username: "kubewatch"
      emoji: ":robot_face:"
  valuesFrom:
    - kind: Secret
      name: kubewatch
      valuesKey: webhook_url
      targetPath: slackwebhook.slackwebhookurl
